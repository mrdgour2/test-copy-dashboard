<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student-Teacher Portal</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
    }

    body {
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background-color: #4a6fa5;
      color: white;
      padding: 1rem 0;
      text-align: center;
      margin-bottom: 2rem;
    }

    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    input[type="password"],
    input[type="tel"],
    input[type="email"],
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }

    button {
      background-color: #4a6fa5;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #3a5a8a;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .btn-secondary {
      background-color: #6c757d;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table, th, td {
      border: 1px solid #ddd;
    }

    th, td {
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    a {
      color: #4a6fa5;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .dashboard-nav {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .dashboard-nav h1 {
      margin: 0;
    }

    .file-upload {
      margin: 20px 0;
    }

    .file-upload input[type="file"] {
      display: none;
    }

    .file-upload label {
      display: inline-block;
      padding: 10px 15px;
      background-color: #4a6fa5;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .file-upload label:hover {
      background-color: #3a5a8a;
    }

    .notification {
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .hidden {
      display: none;
    }

    .page {
      display: none;
    }

    .active {
      display: block;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    /* Progress bar styles */
    .progress-container {
      width: 100%;
      background-color: #f3f3f3;
      border-radius: 4px;
      margin: 15px 0;
      display: none;
    }

    .progress-bar {
      height: 20px;
      background-color: #4a6fa5;
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s;
    }

    .progress-text {
      text-align: center;
      margin-top: 5px;
      font-size: 14px;
      color: #666;
    }

    .student-info {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Student-Teacher Portal</h1>
  </header>
  
  <div class="container">
    <!-- Index Page -->
    <div id="indexPage" class="page active">
      <div class="card">
        <h2>Login Options</h2>
        <div style="display: flex; justify-content: space-around; margin-top: 30px;">
          <div style="text-align: center;">
            <h3>Student Login</h3>
            <p>Login as a student to upload and view your test copies</p>
            <button onclick="showPage('studentLoginPage')" style="display: inline-block; margin-top: 15px; padding: 10px 20px;">Student Login</button>
          </div>
          <div style="text-align: center;">
            <h3>Teacher Login</h3>
            <p>Login as a teacher to check and manage student test copies</p>
            <button onclick="showPage('teacherLoginPage')" style="display: inline-block; margin-top: 15px; padding: 10px 20px;">Teacher Login</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Student Login Page -->
    <div id="studentLoginPage" class="page">
      <div class="card" style="max-width: 500px; margin: 0 auto;">
        <h2>Login to Your Account</h2>
        <div id="studentLoginNotification" class="notification hidden"></div>
        
        <form id="studentLoginForm">
          <div class="form-group">
            <label for="studentMobile">Mobile Number</label>
            <input type="tel" id="studentMobile" name="mobile" required>
          </div>
          
          <div class="form-group">
            <label for="studentPassword">Password</label>
            <input type="password" id="studentPassword" name="password" required>
          </div>
          
          <button type="submit">Login</button>
        </form>
        
        <div style="margin-top: 20px; text-align: center;">
          <p>Don't have an account? <button onclick="showPage('studentRegisterPage')" style="background: none; color: #4a6fa5; text-decoration: underline; padding: 0; font-size: 16px;">Register here</button></p>
          <p><button onclick="showPage('indexPage')" style="background: none; color: #4a6fa5; text-decoration: underline; padding: 0; font-size: 16px;">Back to Home</button></p>
        </div>
      </div>
    </div>

    <!-- Teacher Login Page -->
    <div id="teacherLoginPage" class="page">
      <div class="card" style="max-width: 500px; margin: 0 auto;">
        <h2>Login to Your Account</h2>
        <div id="teacherLoginNotification" class="notification hidden"></div>
        
        <form id="teacherLoginForm">
          <div class="form-group">
            <label for="teacherEmail">Email</label>
            <input type="email" id="teacherEmail" name="email" required>
          </div>
          
          <div class="form-group">
            <label for="teacherPassword">Password</label>
            <input type="password" id="teacherPassword" name="password" required>
          </div>
          
          <button type="submit">Login</button>
        </form>
        
        <div style="margin-top: 20px; text-align: center;">
          <p><button onclick="showPage('indexPage')" style="background: none; color: #4a6fa5; text-decoration: underline; padding: 0; font-size: 16px;">Back to Home</button></p>
        </div>
      </div>
    </div>

    <!-- Student Register Page -->
    <div id="studentRegisterPage" class="page">
      <div class="card" style="max-width: 500px; margin: 0 auto;">
        <h2>Create Your Account</h2>
        <div id="studentRegisterNotification" class="notification hidden"></div>
        
        <form id="studentRegisterForm">
          <div class="form-group">
            <label for="studentName">Full Name</label>
            <input type="text" id="studentName" name="name" required>
          </div>
          
          <div class="form-group">
            <label for="studentRegMobile">Mobile Number</label>
            <input type="tel" id="studentRegMobile" name="mobile" required>
          </div>
          
          <div class="form-group">
            <label for="studentRegPassword">Password</label>
            <input type="password" id="studentRegPassword" name="password" required>
          </div>
          
          <div class="form-group">
            <label for="studentConfirmPassword">Confirm Password</label>
            <input type="password" id="studentConfirmPassword" name="confirmPassword" required>
          </div>
          
          <button type="submit">Register</button>
        </form>
        
        <div style="margin-top: 20px; text-align: center;">
          <p>Already have an account? <button onclick="showPage('studentLoginPage')" style="background: none; color: #4a6fa5; text-decoration: underline; padding: 0; font-size: 16px;">Login here</button></p>
        </div>
      </div>
    </div>

    <!-- Student Dashboard Page -->
    <div id="studentDashboardPage" class="page">
      <header>
        <div class="container">
          <div class="dashboard-nav">
            <h1>Student Dashboard</h1>
            <button id="studentLogoutBtn" class="btn-secondary">Logout</button>
          </div>
        </div>
      </header>
      
      <div class="container">
        <div class="card">
          <h2>Upload Test Copy</h2>
          <div id="studentUploadNotification" class="notification hidden"></div>
          
          <div class="file-upload">
            <input type="file" id="testCopyFile" accept=".pdf" required>
            <label for="testCopyFile">Choose PDF File</label>
            <span id="fileName" style="margin-left: 10px;">No file chosen</span>
          </div>
          
          <!-- Progress bar for student upload -->
          <div id="studentProgressContainer" class="progress-container">
            <div id="studentProgressBar" class="progress-bar"></div>
          </div>
          <div id="studentProgressText" class="progress-text hidden"></div>
          
          <button id="uploadBtn">Upload</button>
        </div>
        
        <div class="card">
          <h2>Your Uploaded Copies</h2>
          <div id="copiesList">
            <div id="uploadedCopiesLoading" class="loading">Loading your uploaded copies...</div>
            <table id="uploadedCopiesTable" style="display: none;">
              <thead>
                <tr>
                  <th>S.No</th>
                  <th>File Name</th>
                  <th>Upload Date</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="copiesTableBody">
                <!-- Table rows will be added dynamically -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card">
          <h2>Checked Copies</h2>
          <div id="checkedCopiesList">
            <div id="checkedCopiesLoading" class="loading">Loading your checked copies...</div>
            <table id="checkedCopiesTable" style="display: none;">
              <thead>
                <tr>
                  <th>S.No</th>
                  <th>File Name</th>
                  <th>Check Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="checkedCopiesTableBody">
                <!-- Table rows will be added dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Teacher Dashboard Page -->
    <div id="teacherDashboardPage" class="page">
      <header>
        <div class="container">
          <div class="dashboard-nav">
            <h1>Teacher Dashboard</h1>
            <button id="teacherLogoutBtn" class="btn-secondary">Logout</button>
          </div>
        </div>
      </header>
      
      <div class="container">
        <div class="card">
          <h2>Find Student</h2>
          <div class="form-group">
            <label for="teacherStudentMobile">Student Mobile Number</label>
            <input type="tel" id="teacherStudentMobile" placeholder="Enter student's mobile number">
            <button id="searchBtn" style="margin-top: 10px;">Search</button>
          </div>
          
          <div id="studentInfo" class="hidden">
            <div class="student-info">
              <h3>Student Information</h3>
              <p><strong>Name:</strong> <span id="studentName"></span></p>
              <p><strong>Mobile:</strong> <span id="studentMobileDisplay"></span></p>
            </div>
            
            <div class="file-upload" style="margin-top: 15px;">
              <input type="file" id="checkedCopyFile" accept=".pdf" required>
              <label for="checkedCopyFile">Choose Checked PDF File</label>
              <span id="checkedFileName" style="margin-left: 10px;">No file chosen</span>
            </div>
            
            <!-- Progress bar for teacher upload -->
            <div id="teacherProgressContainer" class="progress-container">
              <div id="teacherProgressBar" class="progress-bar"></div>
            </div>
            <div id="teacherProgressText" class="progress-text hidden"></div>
            
            <button id="uploadCheckedBtn" style="margin-top: 10px;">Upload Checked Copy</button>
          </div>
          
          <div id="searchNotification" class="notification hidden"></div>
        </div>
        
        <div class="card">
          <h2>Pending Test Copies</h2>
          <div id="pendingCopiesList">
            <div id="pendingCopiesLoading" class="loading">Loading pending test copies...</div>
            <table id="pendingCopiesTable" style="display: none;">
              <thead>
                <tr>
                  <th>S.No</th>
                  <th>Student Name</th>
                  <th>Student Mobile</th>
                  <th>File Name</th>
                  <th>Upload Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="pendingCopiesTableBody">
                <!-- Table rows will be added dynamically -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card">
          <h2>Checked Copies</h2>
          <div id="teacherCheckedCopiesList">
            <div id="teacherCheckedCopiesLoading" class="loading">Loading checked copies...</div>
            <table id="teacherCheckedCopiesTable" style="display: none;">
              <thead>
                <tr>
                  <th>S.No</th>
                  <th>Student Name</th>
                  <th>Student Mobile</th>
                  <th>File Name</th>
                  <th>Check Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="teacherCheckedCopiesTableBody">
                <!-- Table rows will be added dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase configuration - replace with your own
    const firebaseConfig = {
    apiKey: "AIzaSyD8x9IaO9l2esQrI147mskCCdRjXKinBzM",
    authDomain: "test-copy-dashboard.firebaseapp.com",
    projectId: "test-copy-dashboard",
    storageBucket: "test-copy-dashboard.firebasestorage.app",
    messagingSenderId: "201941694667",
    appId: "1:201941694667:web:caa01ca6a45aa7658a434e"
  };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Page navigation
    function showPage(pageId) {
      // Hide all pages
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      // Show the selected page
      document.getElementById(pageId).classList.add('active');
      
      // Initialize page-specific functionality
      if (pageId === 'studentDashboardPage') {
        initializeStudentDashboard();
      } else if (pageId === 'teacherDashboardPage') {
        initializeTeacherDashboard();
      }
    }

    // Student registration
    function registerStudent(name, mobile, password) {
      return auth.createUserWithEmailAndPassword(`${mobile}@student.com`, password)
        .then((userCredential) => {
          // Add student to Firestore
          return db.collection('students').doc(userCredential.user.uid).set({
            name: name,
            mobile: mobile,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
    }

    // Student login
    function loginStudent(mobile, password) {
      return auth.signInWithEmailAndPassword(`${mobile}@student.com`, password);
    }

    // Teacher login
    function loginTeacher(email, password) {
      return auth.signInWithEmailAndPassword(email, password);
    }

    // Logout
    function logout() {
      return auth.signOut();
    }

    // Upload test copy (using Firestore instead of Storage)
    function uploadTestCopy(studentId, file, onProgress) {
      return new Promise((resolve, reject) => {
        // Check file size (Firestore has 1MB limit per document)
        if (file.size > 1000000) { // 1MB in bytes
          reject(new Error("File size must be less than 1MB"));
          return;
        }

        const reader = new FileReader();
        
        // Track progress
        reader.onprogress = function(event) {
          if (event.lengthComputable && onProgress) {
            const percentLoaded = Math.round((event.loaded / event.total) * 100);
            onProgress(percentLoaded);
          }
        };
        
        reader.onload = function(event) {
          const base64 = event.target.result;
          
          // Add to Firestore
          db.collection('testCopies').add({
            studentId: studentId,
            fileName: file.name,
            fileData: base64,
            uploadDate: firebase.firestore.FieldValue.serverTimestamp(),
            status: 'pending'
          })
          .then(docRef => {
            console.log('Document written with ID: ', docRef.id);
            resolve(docRef.id);
          })
          .catch(error => {
            console.error('Error adding document: ', error);
            reject(error);
          });
        };
        
        reader.onerror = function(error) {
          console.error('FileReader error: ', error);
          reject(error);
        };
        
        // Start reading the file
        reader.readAsDataURL(file);
      });
    }

    // Get student's uploaded copies
    function getStudentCopies(studentId) {
      return db.collection('testCopies')
        .where('studentId', '==', studentId)
        .orderBy('uploadDate', 'desc')
        .get();
    }

    // Get checked copies for student
    function getCheckedCopies(studentId) {
      return db.collection('checkedCopies')
        .where('studentId', '==', studentId)
        .orderBy('checkDate', 'desc')
        .get();
    }

    // Get all students
    function getAllStudents() {
      return db.collection('students').get();
    }

    // Get student by mobile number
    function getStudentByMobile(mobile) {
      return db.collection('students')
        .where('mobile', '==', mobile)
        .get();
    }

    // Get pending test copies
    function getPendingCopies() {
      return db.collection('testCopies')
        .where('status', '==', 'pending')
        .get();
    }

    // Get checked copies for teacher
    function getCheckedCopiesForTeacher() {
      return db.collection('checkedCopies')
        .orderBy('checkDate', 'desc')
        .get();
    }

    // Upload checked copy (using Firestore instead of Storage)
    function uploadCheckedCopy(studentId, testCopyId, file, onProgress) {
      return new Promise((resolve, reject) => {
        // Check file size (Firestore has 1MB limit per document)
        if (file.size > 1000000) { // 1MB in bytes
          reject(new Error("File size must be less than 1MB"));
          return;
        }

        const reader = new FileReader();
        
        // Track progress
        reader.onprogress = function(event) {
          if (event.lengthComputable && onProgress) {
            const percentLoaded = Math.round((event.loaded / event.total) * 100);
            onProgress(percentLoaded);
          }
        };
        
        reader.onload = function(event) {
          const base64 = event.target.result;
          
          // Add checked copy to Firestore
          db.collection('checkedCopies').add({
            studentId: studentId,
            testCopyId: testCopyId,
            fileName: file.name,
            fileData: base64,
            checkDate: firebase.firestore.FieldValue.serverTimestamp()
          })
          .then(docRef => {
            // Update test copy status
            return db.collection('testCopies').doc(testCopyId).update({
              status: 'checked'
            })
            .then(() => {
              resolve(docRef.id);
            });
          })
          .catch(error => {
            console.error('Error adding checked copy: ', error);
            reject(error);
          });
        };
        
        reader.onerror = function(error) {
          console.error('FileReader error: ', error);
          reject(error);
        };
        
        // Start reading the file
        reader.readAsDataURL(file);
      });
    }

    // View PDF function
    function viewPDF(base64, fileName) {
      // Create a new window
      const win = window.open();
      
      // Create an iframe to display the PDF
      win.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${fileName}</title>
          <style>
            body { margin: 0; padding: 0; }
            iframe { width: 100%; height: 100vh; border: none; }
          </style>
        </head>
        <body>
          <iframe src="${base64}"></iframe>
        </body>
        </html>
      `);
    }

    // Initialize Student Dashboard
    function initializeStudentDashboard() {
      // Check if user is authenticated
      if (!auth.currentUser) {
        console.error('User not authenticated');
        showPage('studentLoginPage');
        return;
      }

      const studentId = auth.currentUser.uid;
      console.log('Initializing student dashboard for user:', studentId);
      
      // Load student data
      loadStudentData(studentId);
      
      // File input change
      const fileInput = document.getElementById('testCopyFile');
      if (fileInput) {
        fileInput.addEventListener('change', function() {
          const fileName = this.files[0] ? this.files[0].name : 'No file chosen';
          document.getElementById('fileName').textContent = fileName;
        });
      }
      
      // Upload button
      const uploadBtn = document.getElementById('uploadBtn');
      if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
          // Check if user is authenticated
          if (!auth.currentUser) {
            const notification = document.getElementById('studentUploadNotification');
            notification.textContent = 'You must be logged in to upload a file';
            notification.classList.remove('hidden');
            notification.classList.add('error');
            return;
          }

          const fileInput = document.getElementById('testCopyFile');
          const notification = document.getElementById('studentUploadNotification');
          
          if (!fileInput.files[0]) {
            notification.textContent = 'Please select a file to upload';
            notification.classList.remove('hidden');
            notification.classList.add('error');
            return;
          }
          
          const file = fileInput.files[0];
          
          // Check file size
          if (file.size > 1000000) { // 1MB in bytes
            notification.textContent = 'File size must be less than 1MB';
            notification.classList.remove('hidden');
            notification.classList.add('error');
            return;
          }
          
          const studentId = auth.currentUser.uid;
          console.log('Uploading file for student:', studentId);
          
          // Show progress bar
          const progressContainer = document.getElementById('studentProgressContainer');
          const progressBar = document.getElementById('studentProgressBar');
          const progressText = document.getElementById('studentProgressText');
          
          if (progressContainer) progressContainer.style.display = 'block';
          if (progressBar) progressBar.style.width = '0%';
          if (progressText) {
            progressText.classList.remove('hidden');
            progressText.textContent = 'Uploading... 0%';
          }
          
          // Disable upload button during upload
          uploadBtn.disabled = true;
          
          uploadTestCopy(studentId, file, function(percentLoaded) {
            // Update progress bar
            if (progressBar) progressBar.style.width = percentLoaded + '%';
            if (progressText) progressText.textContent = `Uploading... ${percentLoaded}%`;
          })
          .then(() => {
            notification.textContent = 'File uploaded successfully!';
            notification.classList.remove('hidden');
            notification.classList.remove('error');
            
            // Reset file input
            fileInput.value = '';
            document.getElementById('fileName').textContent = 'No file chosen';
            
            // Hide progress bar
            if (progressContainer) progressContainer.style.display = 'none';
            if (progressText) progressText.classList.add('hidden');
            
            // Enable upload button
            uploadBtn.disabled = false;
            
            // Reload the copies list
            loadStudentCopies(studentId);
          })
          .catch(error => {
            console.error('Upload error:', error);
            notification.textContent = 'Error uploading file: ' + error.message;
            notification.classList.remove('hidden');
            notification.classList.add('error');
            
            // Hide progress bar
            if (progressContainer) progressContainer.style.display = 'none';
            if (progressText) progressText.classList.add('hidden');
            
            // Enable upload button
            uploadBtn.disabled = false;
          });
        });
      }
      
      // Logout button
      const logoutBtn = document.getElementById('studentLogoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          logout().then(() => {
            showPage('indexPage');
          });
        });
      }
    }

    // Initialize Teacher Dashboard
    function initializeTeacherDashboard() {
      // Check if user is authenticated
      if (!auth.currentUser) {
        console.error('User not authenticated');
        showPage('teacherLoginPage');
        return;
      }

      console.log('Initializing teacher dashboard for user:', auth.currentUser.uid);
      
      // Load pending copies and checked copies
      loadPendingCopies();
      loadCheckedCopiesForTeacher();
      
      // File input change
      const fileInput = document.getElementById('checkedCopyFile');
      if (fileInput) {
        fileInput.addEventListener('change', function() {
          const fileName = this.files[0] ? this.files[0].name : 'No file chosen';
          document.getElementById('checkedFileName').textContent = fileName;
        });
      }
      
      // Search button
      const searchBtn = document.getElementById('searchBtn');
      if (searchBtn) {
        searchBtn.addEventListener('click', function() {
          const mobile = document.getElementById('teacherStudentMobile').value;
          const notification = document.getElementById('searchNotification');
          
          if (!mobile) {
            notification.textContent = 'Please enter a mobile number';
            notification.classList.remove('hidden');
            notification.classList.add('error');
            return;
          }
          
          getStudentByMobile(mobile)
            .then(querySnapshot => {
              if (querySnapshot.empty) {
                notification.textContent = 'No student found with this mobile number';
                notification.classList.remove('hidden');
                notification.classList.add('error');
                document.getElementById('studentInfo').classList.add('hidden');
                return;
              }
              
              const studentDoc = querySnapshot.docs[0];
              const studentData = studentDoc.data();
              
              document.getElementById('studentName').textContent = studentData.name;
              document.getElementById('studentMobileDisplay').textContent = studentData.mobile;
              document.getElementById('studentInfo').classList.remove('hidden');
              document.getElementById('studentInfo').dataset.studentId = studentDoc.id;
              document.getElementById('studentInfo').dataset.studentName = studentData.name;
              
              notification.textContent = 'Student found! You can now upload a checked copy.';
              notification.classList.remove('hidden');
              notification.classList.remove('error');
            })
            .catch(error => {
              console.error('Error searching for student:', error);
              notification.textContent = error.message;
              notification.classList.remove('hidden');
              notification.classList.add('error');
            });
        });
      }
      
      // Upload checked copy button
      const uploadCheckedBtn = document.getElementById('uploadCheckedBtn');
      if (uploadCheckedBtn) {
        uploadCheckedBtn.addEventListener('click', function() {
          const fileInput = document.getElementById('checkedCopyFile');
          const studentInfo = document.getElementById('studentInfo');
          const notification = document.getElementById('searchNotification');
          
          if (!fileInput.files[0]) {
            notification.textContent = 'Please select a file to upload';
            notification.classList.remove('hidden');
            notification.classList.add('error');
            return;
          }
          
          const file = fileInput.files[0];
          
          // Check file size
          if (file.size > 1000000) { // 1MB in bytes
            notification.textContent = 'File size must be less than 1MB';
            notification.classList.remove('hidden');
            notification.classList.add('error');
            return;
          }
          
          if (!studentInfo.dataset.studentId) {
            notification.textContent = 'Please search for a student first';
            notification.classList.remove('hidden');
            notification.classList.add('error');
            return;
          }
          
          const studentId = studentInfo.dataset.studentId;
          console.log('Uploading checked copy for student:', studentId);
          
          // Show progress bar
          const progressContainer = document.getElementById('teacherProgressContainer');
          const progressBar = document.getElementById('teacherProgressBar');
          const progressText = document.getElementById('teacherProgressText');
          
          if (progressContainer) progressContainer.style.display = 'block';
          if (progressBar) progressBar.style.width = '0%';
          if (progressText) {
            progressText.classList.remove('hidden');
            progressText.textContent = 'Uploading... 0%';
          }
          
          // Disable upload button during upload
          uploadCheckedBtn.disabled = true;
          
          // Find a pending copy for this student
          db.collection('testCopies')
            .where('studentId', '==', studentId)
            .where('status', '==', 'pending')
            .limit(1)
            .get()
            .then(querySnapshot => {
              if (querySnapshot.empty) {
                notification.textContent = 'No pending copy found for this student';
                notification.classList.remove('hidden');
                notification.classList.add('error');
                
                // Hide progress bar
                if (progressContainer) progressContainer.style.display = 'none';
                if (progressText) progressText.classList.add('hidden');
                
                // Enable upload button
                uploadCheckedBtn.disabled = false;
                
                return;
              }
              
              const testCopyDoc = querySnapshot.docs[0];
              const testCopyId = testCopyDoc.id;
              
              uploadCheckedCopy(studentId, testCopyId, file, function(percentLoaded) {
                // Update progress bar
                if (progressBar) progressBar.style.width = percentLoaded + '%';
                if (progressText) progressText.textContent = `Uploading... ${percentLoaded}%`;
              })
              .then(() => {
                notification.textContent = 'Checked copy uploaded successfully!';
                notification.classList.remove('hidden');
                notification.classList.remove('error');
                
                // Reset file input
                fileInput.value = '';
                document.getElementById('checkedFileName').textContent = 'No file chosen';
                
                // Hide progress bar
                if (progressContainer) progressContainer.style.display = 'none';
                if (progressText) progressText.classList.add('hidden');
                
                // Enable upload button
                uploadCheckedBtn.disabled = false;
                
                // Reload the pending copies and checked copies
                loadPendingCopies();
                loadCheckedCopiesForTeacher();
              })
              .catch(error => {
                console.error('Error uploading checked copy:', error);
                notification.textContent = error.message;
                notification.classList.remove('hidden');
                notification.classList.add('error');
                
                // Hide progress bar
                if (progressContainer) progressContainer.style.display = 'none';
                if (progressText) progressText.classList.add('hidden');
                
                // Enable upload button
                uploadCheckedBtn.disabled = false;
              });
            })
            .catch(error => {
              console.error('Error finding pending copy:', error);
              notification.textContent = error.message;
              notification.classList.remove('hidden');
              notification.classList.add('error');
              
              // Hide progress bar
              if (progressContainer) progressContainer.style.display = 'none';
              if (progressText) progressText.classList.add('hidden');
              
              // Enable upload button
              uploadCheckedBtn.disabled = false;
            });
        });
      }
      
      // Logout button
      const logoutBtn = document.getElementById('teacherLogoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          logout().then(() => {
            showPage('indexPage');
          });
        });
      }
    }

    // Load student data
    function loadStudentData(studentId) {
      console.log('Loading student data for:', studentId);
      loadStudentCopies(studentId);
      loadCheckedCopies(studentId);
    }

    // Load student copies
    function loadStudentCopies(studentId) {
      console.log('Loading student copies for:', studentId);
      
      // Show loading indicator
      const loadingElement = document.getElementById('uploadedCopiesLoading');
      const tableElement = document.getElementById('uploadedCopiesTable');
      
      if (loadingElement) loadingElement.style.display = 'block';
      if (tableElement) tableElement.style.display = 'none';
      
      getStudentCopies(studentId)
        .then(querySnapshot => {
          const tableBody = document.getElementById('copiesTableBody');
          if (!tableBody) return;
          
          tableBody.innerHTML = '';
          
          if (querySnapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No copies uploaded yet</td></tr>';
          } else {
            let serialNo = 1;
            querySnapshot.forEach(doc => {
              const data = doc.data();
              const row = document.createElement('tr');
              
              const date = data.uploadDate ? new Date(data.uploadDate.toDate()).toLocaleDateString() : 'N/A';
              
              row.innerHTML = `
                <td>${serialNo++}</td>
                <td>${data.fileName}</td>
                <td>${date}</td>
                <td>${data.status}</td>
                <td><a href="#" onclick="viewPDF('${data.fileData}', '${data.fileName}')">View</a></td>
              `;
              
              tableBody.appendChild(row);
            });
          }
          
          // Hide loading and show table
          if (loadingElement) loadingElement.style.display = 'none';
          if (tableElement) tableElement.style.display = 'table';
        })
        .catch(error => {
          console.error('Error loading copies:', error);
          
          // Hide loading and show error
          if (loadingElement) loadingElement.style.display = 'none';
          if (tableElement) tableElement.style.display = 'table';
          
          const tableBody = document.getElementById('copiesTableBody');
          if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Error loading copies</td></tr>';
          }
        });
    }

    // Load checked copies for student
    function loadCheckedCopies(studentId) {
      console.log('Loading checked copies for:', studentId);
      
      // Show loading indicator
      const loadingElement = document.getElementById('checkedCopiesLoading');
      const tableElement = document.getElementById('checkedCopiesTable');
      
      if (loadingElement) loadingElement.style.display = 'block';
      if (tableElement) tableElement.style.display = 'none';
      
      getCheckedCopies(studentId)
        .then(querySnapshot => {
          const tableBody = document.getElementById('checkedCopiesTableBody');
          if (!tableBody) return;
          
          tableBody.innerHTML = '';
          
          if (querySnapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No checked copies yet</td></tr>';
          } else {
            let serialNo = 1;
            querySnapshot.forEach(doc => {
              const data = doc.data();
              const row = document.createElement('tr');
              
              const date = data.checkDate ? new Date(data.checkDate.toDate()).toLocaleDateString() : 'N/A';
              
              row.innerHTML = `
                <td>${serialNo++}</td>
                <td>${data.fileName}</td>
                <td>${date}</td>
                <td><a href="#" onclick="viewPDF('${data.fileData}', '${data.fileName}')">View</a></td>
              `;
              
              tableBody.appendChild(row);
            });
          }
          
          // Hide loading and show table
          if (loadingElement) loadingElement.style.display = 'none';
          if (tableElement) tableElement.style.display = 'table';
        })
        .catch(error => {
          console.error('Error loading checked copies:', error);
          
          // Hide loading and show error
          if (loadingElement) loadingElement.style.display = 'none';
          if (tableElement) tableElement.style.display = 'table';
          
          const tableBody = document.getElementById('checkedCopiesTableBody');
          if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Error loading checked copies</td></tr>';
          }
        });
    }

    // Load pending copies
    function loadPendingCopies() {
      console.log('Loading pending copies');
      
      // Show loading indicator
      const loadingElement = document.getElementById('pendingCopiesLoading');
      const tableElement = document.getElementById('pendingCopiesTable');
      
      if (loadingElement) loadingElement.style.display = 'block';
      if (tableElement) tableElement.style.display = 'none';
      
      getPendingCopies()
        .then(querySnapshot => {
          const tableBody = document.getElementById('pendingCopiesTableBody');
          if (!tableBody) return;
          
          tableBody.innerHTML = '';
          
          if (querySnapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No pending copies</td></tr>';
          } else {
            // Get student information for each copy
            const promises = [];
            querySnapshot.forEach(doc => {
              const copyData = doc.data();
              const studentPromise = db.collection('students').doc(copyData.studentId).get();
              promises.push({ copyData, docId: doc.id, studentPromise });
            });
            
            Promise.all(promises.map(p => p.studentPromise))
              .then(studentDocs => {
                let serialNo = 1;
                promises.forEach((p, index) => {
                  const studentDoc = studentDocs[index];
                  const studentData = studentDoc.data();
                  const row = document.createElement('tr');
                  
                  const date = p.copyData.uploadDate ? new Date(p.copyData.uploadDate.toDate()).toLocaleDateString() : 'N/A';
                  
                  row.innerHTML = `
                    <td>${serialNo++}</td>
                    <td>${studentData.name}</td>
                    <td>${studentData.mobile}</td>
                    <td>${p.copyData.fileName}</td>
                    <td>${date}</td>
                    <td>
                      <a href="#" onclick="viewPDF('${p.copyData.fileData}', '${p.copyData.fileName}')">View</a>
                      <button class="btn-secondary" onclick="selectStudent('${studentData.mobile}')" style="margin-left: 10px;">Check</button>
                    </td>
                  `;
                  
                  tableBody.appendChild(row);
                });
              });
          }
          
          // Hide loading and show table
          if (loadingElement) loadingElement.style.display = 'none';
          if (tableElement) tableElement.style.display = 'table';
        })
        .catch(error => {
          console.error('Error loading pending copies:', error);
          
          // Hide loading and show error
          if (loadingElement) loadingElement.style.display = 'none';
          if (tableElement) tableElement.style.display = 'table';
          
          const tableBody = document.getElementById('pendingCopiesTableBody');
          if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Error loading pending copies</td></tr>';
          }
        });
    }

    // Load checked copies for teacher
    function loadCheckedCopiesForTeacher() {
      console.log('Loading checked copies for teacher');
      
      // Show loading indicator
      const loadingElement = document.getElementById('teacherCheckedCopiesLoading');
      const tableElement = document.getElementById('teacherCheckedCopiesTable');
      
      if (loadingElement) loadingElement.style.display = 'block';
      if (tableElement) tableElement.style.display = 'none';
      
      getCheckedCopiesForTeacher()
        .then(querySnapshot => {
          const tableBody = document.getElementById('teacherCheckedCopiesTableBody');
          if (!tableBody) return;
          
          tableBody.innerHTML = '';
          
          if (querySnapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No checked copies yet</td></tr>';
          } else {
            // Get student information for each copy
            const promises = [];
            querySnapshot.forEach(doc => {
              const copyData = doc.data();
              const studentPromise = db.collection('students').doc(copyData.studentId).get();
              promises.push({ copyData, docId: doc.id, studentPromise });
            });
            
            Promise.all(promises.map(p => p.studentPromise))
              .then(studentDocs => {
                let serialNo = 1;
                promises.forEach((p, index) => {
                  const studentDoc = studentDocs[index];
                  const studentData = studentDoc.data();
                  const row = document.createElement('tr');
                  
                  const date = p.copyData.checkDate ? new Date(p.copyData.checkDate.toDate()).toLocaleDateString() : 'N/A';
                  
                  row.innerHTML = `
                    <td>${serialNo++}</td>
                    <td>${studentData.name}</td>
                    <td>${studentData.mobile}</td>
                    <td>${p.copyData.fileName}</td>
                    <td>${date}</td>
                    <td>
                      <a href="#" onclick="viewPDF('${p.copyData.fileData}', '${p.copyData.fileName}')">View</a>
                    </td>
                  `;
                  
                  tableBody.appendChild(row);
                });
              });
          }
          
          // Hide loading and show table
          if (loadingElement) loadingElement.style.display = 'none';
          if (tableElement) tableElement.style.display = 'table';
        })
        .catch(error => {
          console.error('Error loading checked copies for teacher:', error);
          
          // Hide loading and show error
          if (loadingElement) loadingElement.style.display = 'none';
          if (tableElement) tableElement.style.display = 'table';
          
          const tableBody = document.getElementById('teacherCheckedCopiesTableBody');
          if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Error loading checked copies</td></tr>';
          }
        });
    }

    // Select student function
    function selectStudent(mobile) {
      document.getElementById('teacherStudentMobile').value = mobile;
      document.getElementById('searchBtn').click();
    }

    // Form submissions
    document.addEventListener('DOMContentLoaded', function() {
      // Student login form
      const studentLoginForm = document.getElementById('studentLoginForm');
      if (studentLoginForm) {
        studentLoginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const mobile = document.getElementById('studentMobile').value;
          const password = document.getElementById('studentPassword').value;
          const notification = document.getElementById('studentLoginNotification');
          
          console.log('Attempting student login for:', mobile);
          
          loginStudent(mobile, password)
            .then(() => {
              console.log('Student login successful');
              showPage('studentDashboardPage');
            })
            .catch(error => {
              console.error('Student login error:', error);
              notification.textContent = error.message;
              notification.classList.remove('hidden');
              notification.classList.add('error');
            });
        });
      }
      
      // Teacher login form
      const teacherLoginForm = document.getElementById('teacherLoginForm');
      if (teacherLoginForm) {
        teacherLoginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const email = document.getElementById('teacherEmail').value;
          const password = document.getElementById('teacherPassword').value;
          const notification = document.getElementById('teacherLoginNotification');
          
          console.log('Attempting teacher login for:', email);
          
          loginTeacher(email, password)
            .then(() => {
              console.log('Teacher login successful');
              showPage('teacherDashboardPage');
            })
            .catch(error => {
              console.error('Teacher login error:', error);
              notification.textContent = error.message;
              notification.classList.remove('hidden');
              notification.classList.add('error');
            });
        });
      }
      
      // Student registration form
      const studentRegisterForm = document.getElementById('studentRegisterForm');
      if (studentRegisterForm) {
        studentRegisterForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const name = document.getElementById('studentName').value;
          const mobile = document.getElementById('studentRegMobile').value;
          const password = document.getElementById('studentRegPassword').value;
          const confirmPassword = document.getElementById('studentConfirmPassword').value;
          const notification = document.getElementById('studentRegisterNotification');
          
          console.log('Attempting student registration for:', mobile);
          
          if (password !== confirmPassword) {
            notification.textContent = 'Passwords do not match';
            notification.classList.remove('hidden');
            notification.classList.add('error');
            return;
          }
          
          registerStudent(name, mobile, password)
            .then(() => {
              console.log('Student registration successful');
              notification.textContent = 'Registration successful! You can now login.';
              notification.classList.remove('hidden');
              notification.classList.remove('error');
              
              setTimeout(() => {
                showPage('studentLoginPage');
              }, 2000);
            })
            .catch(error => {
              console.error('Student registration error:', error);
              notification.textContent = error.message;
              notification.classList.remove('hidden');
              notification.classList.add('error');
            });
        });
      }
    });

    // Check authentication state
    auth.onAuthStateChanged(user => {
      console.log('Auth state changed:', user ? 'User logged in' : 'User logged out');
      
      if (user) {
        // Check if user is a student or teacher
        if (user.email && user.email.includes('@student.com')) {
          // Student is logged in
          console.log('Student logged in:', user.uid);
          if (document.getElementById('studentDashboardPage').classList.contains('active')) {
            loadStudentData(user.uid);
          }
        } else {
          // Teacher is logged in
          console.log('Teacher logged in:', user.uid);
          if (document.getElementById('teacherDashboardPage').classList.contains('active')) {
            loadPendingCopies();
            loadCheckedCopiesForTeacher();
          }
        }
      } else {
        // No user is logged in
        console.log('No user logged in');
        if (document.getElementById('studentDashboardPage').classList.contains('active') ||
            document.getElementById('teacherDashboardPage').classList.contains('active')) {
          showPage('indexPage');
        }
      }
    });
  </script>
</body>
</html>
